"""
Reed-Solomon Error Correction for QR Codes
"""

from .galois_field import GaloisField, Polynomial


class ReedSolomon:
    def __init__(self):
        self.gf = GaloisField()

    def generate_generator_polynomial(self, num_ec_codewords):
        gen = Polynomial([1], self.gf)
        for i in range(num_ec_codewords):
            alpha_i = self.gf.exp_table[i]
            term = Polynomial([1, alpha_i], self.gf)
            gen = gen.multiply(term)
        return gen

    def encode(self, data_codewords, num_ec_codewords):
        data_poly_coeffs = list(data_codewords) + [0] * num_ec_codewords
        data_poly = Polynomial(data_poly_coeffs, self.gf)
        gen_poly = self.generate_generator_polynomial(num_ec_codewords)
        remainder = data_poly.divide(gen_poly)
        ec_codewords = []
        for i in range(num_ec_codewords - 1, -1, -1):
            ec_codewords.append(remainder[i])
        return ec_codewords


EC_LEVELS = {
    'L': {'numeric': 0b01, 'recovery': 0.07},
    'M': {'numeric': 0b00, 'recovery': 0.15},
    'Q': {'numeric': 0b11, 'recovery': 0.25},
    'H': {'numeric': 0b10, 'recovery': 0.30},
}

EC_CODEWORDS_TABLE = {
    (1, 'L'): (7, 1, 0, 0), (1, 'M'): (10, 1, 0, 0), (1, 'Q'): (13, 1, 0, 0), (1, 'H'): (17, 1, 0, 0),
    (2, 'L'): (10, 1, 0, 0), (2, 'M'): (16, 1, 0, 0), (2, 'Q'): (22, 1, 0, 0), (2, 'H'): (28, 1, 0, 0),
    (3, 'L'): (15, 1, 0, 0), (3, 'M'): (26, 1, 0, 0), (3, 'Q'): (18, 2, 0, 0), (3, 'H'): (22, 2, 0, 0),
    (4, 'L'): (20, 1, 0, 0), (4, 'M'): (18, 2, 0, 0), (4, 'Q'): (26, 2, 0, 0), (4, 'H'): (16, 4, 0, 0),
    (5, 'L'): (26, 1, 0, 0), (5, 'M'): (24, 2, 0, 0), (5, 'Q'): (18, 2, 2, 1), (5, 'H'): (22, 2, 2, 1),
    (6, 'L'): (18, 2, 0, 0), (6, 'M'): (16, 4, 0, 0), (6, 'Q'): (24, 4, 0, 0), (6, 'H'): (28, 4, 0, 0),
    (7, 'L'): (20, 2, 0, 0), (7, 'M'): (18, 4, 0, 0), (7, 'Q'): (18, 2, 4, 1), (7, 'H'): (26, 4, 1, 1),
    (8, 'L'): (24, 2, 0, 0), (8, 'M'): (22, 2, 2, 1), (8, 'Q'): (22, 4, 2, 1), (8, 'H'): (26, 4, 2, 1),
    (9, 'L'): (30, 2, 0, 0), (9, 'M'): (22, 3, 2, 1), (9, 'Q'): (20, 4, 4, 1), (9, 'H'): (24, 4, 4, 1),
    (10, 'L'): (18, 2, 2, 1), (10, 'M'): (26, 4, 1, 1), (10, 'Q'): (24, 6, 2, 1), (10, 'H'): (28, 6, 2, 1),
    (11, 'L'): (20, 4, 0, 0), (11, 'M'): (30, 1, 4, 1), (11, 'Q'): (28, 4, 4, 1), (11, 'H'): (24, 3, 8, 1),
    (12, 'L'): (24, 2, 2, 1), (12, 'M'): (22, 6, 2, 1), (12, 'Q'): (26, 4, 6, 1), (12, 'H'): (28, 7, 4, 1),
    (13, 'L'): (26, 4, 0, 0), (13, 'M'): (22, 8, 1, 1), (13, 'Q'): (24, 8, 4, 1), (13, 'H'): (22, 12, 4, 1),
    (14, 'L'): (30, 3, 1, 1), (14, 'M'): (24, 4, 5, 1), (14, 'Q'): (20, 11, 5, 1), (14, 'H'): (24, 11, 5, 1),
    (15, 'L'): (22, 5, 1, 1), (15, 'M'): (24, 5, 5, 1), (15, 'Q'): (30, 5, 7, 1), (15, 'H'): (24, 11, 7, 1),
    (16, 'L'): (24, 5, 1, 1), (16, 'M'): (28, 7, 3, 1), (16, 'Q'): (24, 15, 2, 1), (16, 'H'): (30, 3, 13, 1),
    (17, 'L'): (28, 1, 5, 1), (17, 'M'): (28, 10, 1, 1), (17, 'Q'): (28, 1, 15, 1), (17, 'H'): (28, 2, 17, 1),
    (18, 'L'): (30, 5, 1, 1), (18, 'M'): (26, 9, 4, 1), (18, 'Q'): (28, 17, 1, 1), (18, 'H'): (28, 2, 19, 1),
    (19, 'L'): (28, 3, 4, 1), (19, 'M'): (26, 3, 11, 1), (19, 'Q'): (26, 17, 4, 1), (19, 'H'): (26, 9, 16, 1),
    (20, 'L'): (28, 3, 5, 1), (20, 'M'): (26, 3, 13, 1), (20, 'Q'): (30, 15, 5, 1), (20, 'H'): (28, 15, 10, 1),
    (21, 'L'): (28, 4, 4, 1), (21, 'M'): (26, 17, 0, 0), (21, 'Q'): (28, 17, 6, 1), (21, 'H'): (30, 19, 6, 1),
    (22, 'L'): (28, 2, 7, 1), (22, 'M'): (28, 17, 0, 0), (22, 'Q'): (30, 7, 16, 1), (22, 'H'): (24, 34, 0, 0),
    (23, 'L'): (30, 4, 5, 1), (23, 'M'): (28, 4, 14, 1), (23, 'Q'): (30, 11, 14, 1), (23, 'H'): (30, 16, 14, 1),
    (24, 'L'): (30, 6, 4, 1), (24, 'M'): (28, 6, 14, 1), (24, 'Q'): (30, 11, 16, 1), (24, 'H'): (30, 30, 2, 1),
    (25, 'L'): (26, 8, 4, 1), (25, 'M'): (28, 8, 13, 1), (25, 'Q'): (30, 7, 22, 1), (25, 'H'): (30, 22, 13, 1),
    (26, 'L'): (28, 10, 2, 1), (26, 'M'): (28, 19, 4, 1), (26, 'Q'): (28, 28, 6, 1), (26, 'H'): (30, 33, 4, 1),
    (27, 'L'): (30, 8, 4, 1), (27, 'M'): (28, 22, 3, 1), (27, 'Q'): (30, 8, 26, 1), (27, 'H'): (30, 12, 28, 1),
    (28, 'L'): (30, 3, 10, 1), (28, 'M'): (28, 3, 23, 1), (28, 'Q'): (30, 4, 31, 1), (28, 'H'): (30, 11, 31, 1),
    (29, 'L'): (30, 7, 7, 1), (29, 'M'): (28, 21, 7, 1), (29, 'Q'): (30, 1, 37, 1), (29, 'H'): (30, 19, 26, 1),
    (30, 'L'): (30, 5, 10, 1), (30, 'M'): (28, 19, 10, 1), (30, 'Q'): (30, 15, 25, 1), (30, 'H'): (30, 23, 25, 1),
    (31, 'L'): (30, 13, 3, 1), (31, 'M'): (28, 2, 29, 1), (31, 'Q'): (30, 42, 1, 1), (31, 'H'): (30, 23, 28, 1),
    (32, 'L'): (30, 17, 0, 0), (32, 'M'): (28, 10, 23, 1), (32, 'Q'): (30, 10, 35, 1), (32, 'H'): (30, 19, 35, 1),
    (33, 'L'): (30, 17, 1, 1), (33, 'M'): (28, 14, 21, 1), (33, 'Q'): (30, 29, 19, 1), (33, 'H'): (30, 11, 46, 1),
    (34, 'L'): (30, 13, 6, 1), (34, 'M'): (28, 14, 23, 1), (34, 'Q'): (30, 44, 7, 1), (34, 'H'): (30, 59, 1, 1),
    (35, 'L'): (30, 12, 7, 1), (35, 'M'): (28, 12, 26, 1), (35, 'Q'): (30, 39, 14, 1), (35, 'H'): (30, 22, 41, 1),
    (36, 'L'): (30, 6, 14, 1), (36, 'M'): (28, 6, 34, 1), (36, 'Q'): (30, 46, 10, 1), (36, 'H'): (30, 2, 64, 1),
    (37, 'L'): (30, 17, 4, 1), (37, 'M'): (28, 29, 14, 1), (37, 'Q'): (30, 49, 10, 1), (37, 'H'): (30, 24, 46, 1),
    (38, 'L'): (30, 4, 18, 1), (38, 'M'): (28, 13, 32, 1), (38, 'Q'): (30, 48, 14, 1), (38, 'H'): (30, 42, 32, 1),
    (39, 'L'): (30, 20, 4, 1), (39, 'M'): (28, 40, 7, 1), (39, 'Q'): (30, 43, 22, 1), (39, 'H'): (30, 10, 67, 1),
    (40, 'L'): (30, 19, 6, 1), (40, 'M'): (28, 18, 31, 1), (40, 'Q'): (30, 34, 34, 1), (40, 'H'): (30, 20, 61, 1),
}
